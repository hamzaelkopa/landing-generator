import React, { useState, useEffect } from 'react';
import { 
  Wand2, Sun, Moon, Sparkles, Zap, Download, RefreshCcw, Copy, 
  CheckCircle2, ArrowRight, MousePointer2, Rocket, Shield
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// --- Configuration ---
const API_KEY = "AIzaSyCBgwlvA70Xs_ri2-YCO7t2flAvua5Qo2Y";
const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

const LANGUAGES = {
  ar: { dir: 'rtl', label: 'العربية' },
  fr: { dir: 'ltr', label: 'Français' }
};

const TRANSLATIONS = {
  ar: {
    title: "منشئ صفحات الهبوط الذكي",
    home: {
      hero: "اصنع صفحة هبوط عالمية في ثوانٍ",
      sub: "استخدم قوة الذكاء الاصطناعي لبناء واجهات احترافية، تصدير الكود، وإطلاق مشروعك فوراً.",
      start: "ابدأ البناء الآن",
      features: "المميزات",
    },
    steps: ["التعريف", "المحتوى", "التفاصيل"],
    fields: { name: "اسم المنتج", type: "النوع", cat: "الفئة", desc: "الوصف" },
    actions: { ai: "توليد بالذكاء الاصطناعي", next: "التالي", prev: "السابق", export: "تصدير HTML", copy: "نسخ الكود", back: "العودة" },
    status: { generating: "جاري التوليد...", success: "تم بنجاح", error: "حدث خطأ في الاتصال" }
  },
  fr: {
    title: "AI Landing Builder",
    home: {
      hero: "Créez une Landing Page Pro en secondes",
      sub: "Utilisez l'IA pour construire des interfaces, exporter le code et lancer votre projet instantanément.",
      start: "Commencer à bâtir",
      features: "Fonctionnalités",
    },
    steps: ["Définir", "Contenu", "Détails"],
    fields: { name: "Produit", type: "Type", cat: "Catégorie", desc: "Description" },
    actions: { ai: "Générer avec l'IA", next: "Suivant", prev: "Précédent", export: "Exporter HTML", copy: "Copier", back: "Retour" },
    status: { generating: "Génération...", success: "Succès", error: "Erreur de connexion" }
  }
};

// --- API Helper with Exponential Backoff ---
const callGeminiAI = async (prompt, retries = 5, delay = 1000) => {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
  
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: {
        type: "OBJECT",
        properties: {
          headline: { type: "STRING" },
          subheadline: { type: "STRING" },
          ctaText: { type: "STRING" },
          features: {
            type: "ARRAY",
            items: {
              type: "OBJECT",
              properties: {
                title: { type: "STRING" },
                desc: { type: "STRING" }
              }
            }
          }
        }
      }
    }
  };

  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error("API Error");
      const result = await response.json();
      return JSON.parse(result.candidates[0].content.parts[0].text);
    } catch (err) {
      if (i === retries - 1) throw err;
      await new Error(delay * Math.pow(2, i));
    }
  }
};

// --- Main App ---
export default function App() {
  const [view, setView] = useState('home');
  const [lang, setLang] = useState('ar');
  const [step, setStep] = useState(1);
  const [theme, setTheme] = useState('dark');
  const [isGenerating, setIsGenerating] = useState(false);
  const [copyFeedback, setCopyFeedback] = useState(false);
  const [errorMsg, setErrorMsg] = useState("");

  const t = TRANSLATIONS[lang];

  const [formData, setFormData] = useState({
    productName: '',
    type: '',
    category: '',
    headline: 'عنوان جذاب لمنتجك الجديد',
    subheadline: 'وصف فريد يشرح القيمة المضافة التي تقدمها لعملائك بطريقة ذكية.',
    ctaText: 'ابدأ الآن',
    features: [
      { title: 'سرعة فائقة', desc: 'توصيل الخدمات في أجزاء من الثانية.' },
      { title: 'أمان متكامل', desc: 'حماية بياناتك بأحدث تقنيات التشفير.' },
      { title: 'دعم فني', desc: 'فريق عمل متواجد لمساعدتك على مدار الساعة.' }
    ]
  });

  const handleAICompose = async () => {
    if (!formData.productName) return;
    setIsGenerating(true);
    setErrorMsg("");
    
    const prompt = `Generate a high-converting landing page content in ${lang === 'ar' ? 'Arabic' : 'French'} for a product named "${formData.productName}". 
    The product type is ${formData.type} and category is ${formData.category}. 
    Return JSON with headline, subheadline, ctaText, and 3 features (title and desc).`;

    try {
      const data = await callGeminiAI(prompt);
      setFormData(prev => ({ ...prev, ...data }));
    } catch (err) {
      setErrorMsg(t.status.error);
    } finally {
      setIsGenerating(false);
    }
  };

  const handleDownload = () => {
    const isRtl = lang === 'ar';
    const html = `<!DOCTYPE html>
<html lang="${lang}" dir="${isRtl ? 'rtl' : 'ltr'}">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${formData.productName}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black font-sans">
    <nav class="p-6 flex justify-between items-center border-b">
        <div class="font-bold text-xl">${formData.productName}</div>
        <button class="px-6 py-2 rounded-full bg-black text-white">${formData.ctaText}</button>
    </nav>
    <header class="py-24 px-8 text-center max-w-4xl mx-auto">
        <h1 class="text-6xl font-black mb-6">${formData.headline}</h1>
        <p class="text-xl text-gray-600 mb-10">${formData.subheadline}</p>
        <button class="px-10 py-4 rounded-xl bg-black text-white font-bold text-lg">${formData.ctaText}</button>
    </header>
    <section class="py-20 px-8 grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
        ${formData.features.map(f => `
            <div class="p-8 border rounded-2xl">
                <h3 class="text-xl font-bold mb-2">${f.title}</h3>
                <p class="text-gray-500">${f.desc}</p>
            </div>
        `).join('')}
    </section>
</body>
</html>`;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `landing-${formData.productName}.html`;
    a.click();
  };

  return (
    <div className={`min-h-screen ${theme === 'dark' ? 'bg-[#050505] text-white' : 'bg-white text-black'} transition-colors duration-300`} dir={LANGUAGES[lang].dir}>
      <AnimatePresence mode="wait">
        {view === 'home' ? (
          <motion.div key="home" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="min-h-screen flex flex-col items-center justify-center p-8 text-center">
            <div className="mb-10 w-16 h-16 bg-white text-black rounded-2xl flex items-center justify-center shadow-2xl"><Sparkles size={32} fill="black"/></div>
            <h1 className="text-6xl md:text-8xl font-black italic uppercase mb-6 tracking-tighter">{t.home.hero}</h1>
            <p className="text-xl text-white/40 max-w-2xl mb-10">{t.home.sub}</p>
            <button onClick={() => setView('editor')} className="px-12 py-6 bg-white text-black rounded-2xl font-black uppercase flex items-center gap-4 hover:scale-105 transition-transform active:scale-95 shadow-xl shadow-white/10">
              {t.home.start} <ArrowRight size={24} />
            </button>
          </motion.div>
        ) : (
          <div className="h-screen flex flex-col">
            <header className="h-16 border-b border-white/10 flex items-center justify-between px-6 backdrop-blur-md">
              <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                <div className="w-8 h-8 bg-white text-black rounded-lg flex items-center justify-center"><Sparkles size={16} fill="black"/></div>
                <span className="font-black italic uppercase">Builder.pro</span>
              </div>
              <div className="flex items-center gap-3">
                <button onClick={() => setLang(l => l === 'ar' ? 'fr' : 'ar')} className="text-[10px] font-black uppercase px-3 py-1 border border-white/10 rounded-lg">{LANGUAGES[lang === 'ar' ? 'fr' : 'ar'].label}</button>
                <button onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')} className="p-2 border border-white/10 rounded-xl">{theme === 'dark' ? <Sun size={18}/> : <Moon size={18}/>}</button>
              </div>
            </header>

            <main className="flex-1 flex flex-col lg:flex-row overflow-hidden">
              <aside className={`w-full lg:w-[400px] border-white/10 ${lang === 'ar' ? 'border-l' : 'border-r'} p-8 overflow-y-auto bg-white/[0.02]`}>
                <div className="flex justify-between mb-8">
                  {[1,2,3].map(i => <div key={i} className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-black ${step >= i ? 'bg-white text-black' : 'bg-white/5 text-white/20'}`}>{i}</div>)}
                </div>

                {step === 1 && (
                  <div className="space-y-4">
                    <label className="text-[10px] font-black uppercase opacity-30 tracking-widest">{t.fields.name}</label>
                    <input className="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-white transition-all" value={formData.productName} onChange={e => setFormData({...formData, productName: e.target.value})} />
                    <label className="text-[10px] font-black uppercase opacity-30 tracking-widest">{t.fields.type}</label>
                    <input className="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-white transition-all" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} />
                  </div>
                )}

                {step === 2 && (
                  <div className="space-y-4">
                    <div className="flex justify-between items-center">
                      <h2 className="font-black italic uppercase">AI Generation</h2>
                      <button onClick={handleAICompose} disabled={isGenerating || !formData.productName} className="p-2 bg-white text-black rounded-lg hover:rotate-12 transition-transform disabled:opacity-20">
                        {isGenerating ? <RefreshCcw className="animate-spin" size={16}/> : <Wand2 size={16}/>}
                      </button>
                    </div>
                    {errorMsg && <p className="text-red-500 text-xs font-bold">{errorMsg}</p>}
                    <textarea rows={3} className="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-white transition-all resize-none" value={formData.headline} onChange={e => setFormData({...formData, headline: e.target.value})} />
                    <textarea rows={5} className="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-white transition-all resize-none text-white/60" value={formData.subheadline} onChange={e => setFormData({...formData, subheadline: e.target.value})} />
                  </div>
                )}

                {step === 3 && (
                  <div className="space-y-4">
                    {formData.features.map((f, i) => (
                      <div key={i} className="p-4 bg-white/5 border border-white/10 rounded-xl space-y-2">
                        <input className="bg-transparent font-bold w-full outline-none" value={f.title} onChange={e => {
                          let nf = [...formData.features]; nf[i].title = e.target.value; setFormData({...formData, features: nf});
                        }} />
                        <textarea className="bg-transparent text-xs text-white/40 w-full outline-none resize-none" value={f.desc} onChange={e => {
                          let nf = [...formData.features]; nf[i].desc = e.target.value; setFormData({...formData, features: nf});
                        }} />
                      </div>
                    ))}
                  </div>
                )}

                <div className="mt-8 flex gap-3">
                  {step > 1 && <button onClick={() => setStep(s => s - 1)} className="flex-1 py-4 border border-white/10 rounded-xl font-bold uppercase text-xs">Back</button>}
                  <button onClick={() => step < 3 ? setStep(s => s + 1) : handleDownload()} className="flex-[2] py-4 bg-white text-black rounded-xl font-black uppercase text-xs active:scale-95 transition-transform">
                    {step === 3 ? "Export Page" : "Next Step"}
                  </button>
                </div>
              </aside>

              <section className="flex-1 p-6 lg:p-12 bg-black/50 overflow-y-auto">
                <div className="bg-white text-black min-h-full rounded-[2.5rem] overflow-hidden shadow-2xl" dir={LANGUAGES[lang].dir}>
                  <nav className="p-6 flex justify-between items-center border-b">
                    <div className="font-black text-xl">{formData.productName || "Brand"}</div>
                    <button className="px-5 py-2 rounded-full bg-black text-white text-xs font-bold">{formData.ctaText}</button>
                  </nav>
                  <div className="py-20 px-8 text-center max-w-3xl mx-auto">
                    <h1 className="text-5xl font-black mb-6 leading-tight">{formData.headline}</h1>
                    <p className="text-lg text-gray-500 mb-10">{formData.subheadline}</p>
                    <button className="px-8 py-4 rounded-xl bg-black text-white font-black shadow-lg">{formData.ctaText}</button>
                  </div>
                  <div className="px-8 pb-20 grid md:grid-cols-3 gap-6">
                    {formData.features.map((f, i) => (
                      <div key={i} className="p-6 border border-gray-100 rounded-2xl">
                        <div className="w-10 h-10 bg-gray-50 rounded-lg flex items-center justify-center mb-4"><Zap size={20}/></div>
                        <h3 className="font-bold mb-2">{f.title}</h3>
                        <p className="text-sm text-gray-400">{f.desc}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </section>
            </main>
          </div>
        )}
      </AnimatePresence>
    </div>
  );
}
